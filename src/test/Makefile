# A sample Makefile for building Google Test and using it in user
# tests.  Please tweak it to suit your environment and project.  You
# may want to move it to your project's root directory.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.


# Where to find user code.
USER_DIR = ../main
ROOT = ../..

include $(ROOT)/make/system-id.mk


# specify which files that are included in the test in addition to the unittest file.
# variables available:
#   <test_name>_SRC 
#   <test_name>_DEFINES 


alignsensor_unittest_SRC := \
		$(USER_DIR)/sensors/boardalignment.c \
		$(USER_DIR)/common/maths.c


altitude_hold_unittest_SRC :=  \
		$(USER_DIR)/flight/altitude.c


baro_bmp085_unittest_SRC := \
		$(USER_DIR)/drivers/barometer_bmp085.c \
		$(USER_DIR)/drivers/io.c


baro_bmp280_unittest_SRC := \
		$(USER_DIR)/drivers/barometer_bmp280.c


baro_ms5611_unittest_SRC := \
		$(USER_DIR)/drivers/barometer_ms5611.c


battery_unittest_SRC := \
		$(USER_DIR)/sensors/battery.c \
		$(USER_DIR)/common/maths.c


blackbox_encoding_unittest_SRC :=  \
		$(USER_DIR)/blackbox/blackbox_encoding.c \
		$(USER_DIR)/common/encoding.c \
		$(USER_DIR)/common/printf.c \
		$(USER_DIR)/common/typeconversion.c

cms_unittest_SRC := \
		$(USER_DIR)/cms/cms.c \
		$(USER_DIR)/common/typeconversion.c \
		$(USER_DIR)/drivers/display.c


common_filter_unittest_SRC := \
		$(USER_DIR)/common/filter.c


encoding_unittest_SRC := \
		$(USER_DIR)/common/encoding.c


flight_failsafe_unittest_SRC := \
		$(USER_DIR)/flight/failsafe.c


flight_imu_unittest_SRC := \
		$(USER_DIR)/flight/imu.c \
		$(USER_DIR)/flight/altitude.c \
		$(USER_DIR)/common/maths.c


flight_mixer_unittest :=  \
		$(USER_DIR)/flight/mixer.c \
		$(USER_DIR)/flight/servos.c \
		$(USER_DIR)/common/maths.c


gps_conversion_unittest_SRC := \
		$(USER_DIR)/common/gps_conversion.c


io_serial_unittest_SRC := \
		$(USER_DIR)/io/serial.c


ledstrip_unittest_SRC := \
		$(USER_DIR)/io/ledstrip.c


maths_unittest_SRC := \
		$(USER_DIR)/common/maths.c


parameter_groups_unittest_SRC := \
		$(USER_DIR)/config/parameter_group.c


rc_controls_unittest_SRC := \
		$(USER_DIR)/fc/rc_controls.c \
		$(USER_DIR)/common/maths.c


rx_crsf_unittest_SRC := \
		$(USER_DIR)/rx/crsf.c \
		$(USER_DIR)/common/maths.c


rx_ibus_unittest_SRC := \
		$(USER_DIR)/rx/ibus.c


rx_ranges_unittest_SRC := \
		$(USER_DIR)/rx/rx.c \
		$(USER_DIR)/common/maths.c


rx_rx_unittest_SRC := \
		$(USER_DIR)/rx/rx.c \
		$(USER_DIR)/common/maths.c \
		$(USER_DIR)/config/feature.c


sensor_gyro_unittest_SRC := \
		$(USER_DIR)/sensors/gyro.c \
		$(USER_DIR)/sensors/boardalignment.c \
		$(USER_DIR)/build/debug.c \
		$(USER_DIR)/common/filter.c \
		$(USER_DIR)/common/maths.c \
		$(USER_DIR)/drivers/accgyro_fake.c \
		$(USER_DIR)/drivers/gyro_sync.c


telemetry_crsf_unittest_SRC := \
		$(USER_DIR)/rx/crsf.c \
		$(USER_DIR)/telemetry/crsf.c \
		$(USER_DIR)/common/maths.c \
		$(USER_DIR)/common/streambuf.c \
		$(USER_DIR)/common/gps_conversion.c \
		$(USER_DIR)/fc/runtime_config.c

telemetry_crsf_unittest_DEFINES := \
		FLASH_SIZE=128 \
		STM32F10X_MD \
		__TARGET__="TEST" \
		__REVISION__="revision"


telemetry_hott_unittest_SRC := \
		$(USER_DIR)/telemetry/hott.c \
		$(USER_DIR)/common/gps_conversion.c


telemetry_ibus_unittest_SRC := \
		$(USER_DIR)/telemetry/ibus_shared.c \
		$(USER_DIR)/telemetry/ibus.c


type_conversion_unittest_SRC := \
		$(USER_DIR)/common/typeconversion.c


ws2811_unittest_SRC := \
		$(USER_DIR)/drivers/light_ws2811strip.c

transponder_unittest_SRC := \
		$(USER_DIR)/drivers/transponder_ir_arcitimer.c \
		$(USER_DIR)/drivers/transponder_ir_ilap.c


# Please tweak the following variable definitions as needed by your
# project, except GTEST_HEADERS, which you can use in your own targets
# but shouldn't modify.

# Points to the root of Google Test, relative to where this file is.
# Remember to tweak this if you move this file.
GTEST_DIR = ../../lib/test/gtest


TEST_DIR = unit
USER_INCLUDE_DIR = $(USER_DIR)

OBJECT_DIR = ../../obj/test

# Use clang/clang++ by default
CC  := clang
CXX := clang++

COMMON_FLAGS = \
	-g \
	-Wall \
	-Wextra \
	-ggdb3 \
	-pthread \
	-O0 \
	-DUNIT_TEST \
	-isystem $(GTEST_DIR)/inc \
	-MMD -MP

# Flags passed to the C compiler.
C_FLAGS = $(COMMON_FLAGS) \
	-std=gnu99

# Flags passed to the C++ compiler.
CXX_FLAGS = $(COMMON_FLAGS) \
	-std=gnu++11

ifdef CYGWIN
# Avoid "__float128 is not supported on this target" error
CXX_FLAGS += -D__STRICT_ANSI__
endif


# Compiler flags for coverage instrumentation
ifndef CYGWIN
COVERAGE_FLAGS := --coverage
else
# Avoid "undefined reference to `llvm_gcov_init'" error (disable coverage)
COVERAGE_FLAGS :=
endif

C_FLAGS   += $(COVERAGE_FLAGS)
CXX_FLAGS += $(COVERAGE_FLAGS)

# Determine the OS and set up the parameter group linker flags accordingly
ifdef MACOSX
PG_FLAGS = -Wl,-map,$(OBJECT_DIR)/$@.map
else
PG_FLAGS = -Wl,-T,$(TEST_DIR)/parameter_group.ld -Wl,-Map,$(OBJECT_DIR)/$@.map
endif

# Gather up all of the tests.
TEST_SRC = $(sort $(wildcard $(TEST_DIR)/*.cc))
TESTS = $(TEST_SRC:$(TEST_DIR)/%.cc=%)

# All Google Test headers.  Usually you shouldn't change this
# definition.
GTEST_HEADERS = $(GTEST_DIR)/inc/gtest/*.h

## V                 : Set verbosity level based on the V= parameter
##                     V=0 Low
##                     V=1 High
include ../../make/build_verbosity.mk

# House-keeping build targets.

## test        : Build and run the Unit Tests (default goal)
test: $(TESTS:%=test_%)

## junittest   : Build and run the Unit Tests, producing Junit XML result files."
junittest: EXEC_OPTS = "--gtest_output=xml:$<_results.xml" 
junittest: $(TESTS:%=test_%)



## help        : print this help message and exit
## what        : print this help message and exit
## usage       : print this help message and exit
help what usage: Makefile
	@echo ""
	@echo "Makefile for Unit Tests"
	@echo ""
	@echo "Usage:"
	@echo "        make [goal] "
	@echo ""
	@echo "Valid goals are:"
	@echo ""
	@sed -n 's/^## //p' $<
	@echo ""
	@echo "Any of the Unit Test programs can be used as goals to build:"
	@$(foreach test, $(TESTS), echo "    $(OBJECT_DIR)/$(test)/$(test)";)
	@echo ""
	@echo "Any of the Unit Test programs can be used as goals to build and run:"
	@$(foreach test, $(TESTS), echo "    test_$(test)";)

## clean       : Cleanup the UnitTest binaries.
clean :
	rm -rf $(OBJECT_DIR)


# Builds gtest.a and gtest_main.a.

# Usually you shouldn't tweak such internal variables, indicated by a
# trailing _.
GTEST_SRCS_ = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/inc/gtest/*.h $(GTEST_HEADERS)

# For simplicity and to avoid depending on Google Test's
# implementation details, the dependencies specified below are
# conservative and not optimized.  This is fine as Google Test
# compiles fast and for ordinary users its source rarely changes.
$(OBJECT_DIR)/gtest-all.o : $(GTEST_SRCS_)
	@echo "compiling $@" "$(STDOUT)"
	@mkdir -p $(dir $@)
	$(V1) $(CXX) $(CXX_FLAGS) -I$(GTEST_DIR) -Wno-missing-field-initializers -Wno-unused-const-variable -c \
            $(GTEST_DIR)/src/gtest-all.cc -o $@

$(OBJECT_DIR)/gtest_main.o : $(GTEST_SRCS_)
	@echo "compiling $@" "$(STDOUT)"
	@mkdir -p $(dir $@)
	$(V1) $(CXX) $(CXX_FLAGS) -I$(GTEST_DIR) -c \
            $(GTEST_DIR)/src/gtest_main.cc -o $@

$(OBJECT_DIR)/gtest.a : $(OBJECT_DIR)/gtest-all.o
	@echo "linking $@" "$(STDOUT)"
	$(V1) $(AR) $(ARFLAGS) $@ $^ 

$(OBJECT_DIR)/gtest_main.a : $(OBJECT_DIR)/gtest-all.o $(OBJECT_DIR)/gtest_main.o
	@echo "linking $@" "$(STDOUT)"
	$(V1) $(AR) $(ARFLAGS) $@ $^ 

-include $(OBJECT_DIR)/gtest-all.d \
         $(OBJECT_DIR)/gtest_main.d


# includes in test dir must override includes in user dir
TEST_INCLUDE_DIRS := $(TEST_DIR) \
	$(USER_INCLUDE_DIR)

TEST_CFLAGS	 = $(addprefix -I,$(TEST_INCLUDE_DIRS))




# canned recipe for all test builds
# param $1 = testname
define test-specific-stuff

$$1_OBJS = $$(patsubst $$(USER_DIR)%,$$(OBJECT_DIR)/$1%,$$($1_SRC:=.o)) 

# $$(info $1 -v-v-------)
# $$(info $1_SRC:  $($1_SRC))
# $$(info $1_OBJS: $$($$1_OBJS))
# $$(info $1 -^-^-------)


#include generated dependencies
-include $$($$1_OBJS:.o=.d)
-include $(OBJECT_DIR)/$1/$1.d


$(OBJECT_DIR)/$1/%.c.o: $(USER_DIR)/%.c
	@echo "compiling $$<" "$(STDOUT)"
	$(V1) mkdir -p $$(dir $$@)
	$(V1) $(CC) $(C_FLAGS) $(TEST_CFLAGS) \
                $(foreach def,$1_DEFINES,-D $(def)) \
                -c $$< -o $$@


$(OBJECT_DIR)/$1/$1.o: $(TEST_DIR)/$1.cc
	@echo "compiling $$<" "$(STDOUT)"
	$(V1) mkdir -p $$(dir $$@)
	$(V1) $(CXX) $(CXX_FLAGS) $(TEST_CFLAGS)  \
                 $(foreach def,$1_DEFINES,-D $(def)) \
                 -c $$< -o $$@


$(OBJECT_DIR)/$1/$1 : $$($$1_OBJS) \
    $(OBJECT_DIR)/$1/$1.o \
	$(OBJECT_DIR)/gtest_main.a

	@echo "linking $$@" "$(STDOUT)"
	$(V1) mkdir -p $(dir $$@)
	$(V1) $(CXX) $(CXX_FLAGS) $(PG_FLAGS) $$^ -o $$@


test_$1: $(OBJECT_DIR)/$1/$1
	$(V1) $$< $$(EXEC_OPTS) "$(STDOUT)" && echo "running $$@: PASS"

endef

#apply the canned recipe above to all tests
$(eval $(foreach test,$(TESTS),$(call test-specific-stuff,$(test))))

